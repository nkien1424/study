<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study4 Clone</title>
    <link rel="stylesheet" type="text/css" href="/css/layout.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>
<body>
<!-- Header -->
<div th:fragment="header" class="header">
    <div class="logo" th:onclick="'window.location.href=\'' + @{/} + '\''" style="cursor: pointer;">
        <img src="/images/study4_logo.webp" alt="STUDY4 Logo" style="width: 150px;">
    </div>
    <script src="../js/exam_detail.js"></script>
    <nav>

        <a href="#" onclick="thongbao()">Ch∆∞∆°ng tr√¨nh h·ªçc</a>
        <a href="/home">ƒê·ªÅ thi online</a>
        <a href="/vocabulary">Flashcards</a>
        <a href="/blog">Blog</a>
        <div id="auth-section">
            <a th:href="@{/home/log_in}" style="padding: 2px;color: #fff;" class="btn-login">ƒêƒÉng nh·∫≠p</a>
        </div>
    </nav>
</div>
<div  layout:fragment ="content" >

</div>
<!-- Content -->

<div th:fragment="footer" >
    <div class="footer-container">
        <div class="footer-column">
            <img src="/images/study4_logo.webp" alt="STUDY4 Logo" style="width: 150px;">

        </div>
        <div class="footer-column">
            <h3>V·ªÅ STUDY4</h3>
            <ul>
                <li><a href="#">Gi·ªõi thi·ªáu</a></li>
                <li><a href="#">Li√™n h·ªá</a></li>
                <li><a href="#">ƒêi·ªÅu kho·∫£n b·∫£o m·∫≠t</a></li>
                <li><a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h3>T√†i nguy√™n</h3>
            <ul>
                <li><a href="#">Th∆∞ vi·ªán ƒë·ªÅ thi</a></li>
                <li><a href="#">Blog</a></li>
                <li><a href="#">Kho t√†i li·ªáu</a></li>
            </ul>
        </div>
        <div class="footer-column">
            <h3>Ch√≠nh s√°ch chung</h3>
            <ul>
                <li><a href="#">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</a></li>
                <li><a href="#">H∆∞·ªõng d·∫´n thanh to√°n</a></li>
                <li><a href="#">ƒêi·ªÅu kho·∫£n v√† ƒêi·ªÅu ki·ªán giao d·ªãch</a></li>
                <li><a href="#">Ch√≠nh s√°ch ki·ªÉm h√†ng</a></li>
                <li><a href="#">Ch√≠nh s√°ch giao, nh·∫≠n h√†ng</a></li>
                <li><a href="#">Ph·∫£n h·ªìi, khi·∫øu n·∫°i</a></li>
                <li><a href="#">Ch√≠nh s√°ch chuy·ªÉn ƒë·ªïi, ho√†n h·ªßy</a></li>
            </ul>
        </div>
    </div>
    <div class="footer-bottom">
        C√îNG TY TNHH C√îNG NGH·ªÜ A PLUS | ƒê·ªãa ch·ªâ: S·ªë 15, Ng√µ 208 Gi·∫£i Ph√≥ng, Ph∆∞·ªùng Ph∆∞∆°ng Li·ªát, Qu·∫≠n Thanh Xu√¢n, TP. H√† N·ªôi
    </div>
</div>
</body>
</html>
<script>
   function thongbao() {

       // NgƒÉn h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa th·∫ª <a>
       Swal.fire({
           icon: 'info',
           title: 'üöß ƒêang ph√°t tri·ªÉn',
           text: 'T√≠nh nƒÉng n√†y s·∫Ω s·ªõm ra m·∫Øt!',
           showConfirmButton: false,
           timer: 2000,
           timerProgressBar: true
       });
   }
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error('Token kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ph·∫£i JWT');
            return null;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('access_token');
        const userData = token ? parseJwt(token) : null;
        const authSection = document.getElementById("auth-section");
        // L·∫•y username t·ª´ Google n·∫øu c√≥, ho·∫∑c t·ª´ JWT token n·∫øu kh√¥ng
        const userGoogleElement = document.getElementById('userGoogle');
        const userNameFromGoogle = userGoogleElement ? userGoogleElement.value : null;

        // ∆Øu ti√™n username t·ª´ Google, n·∫øu kh√¥ng c√≥ th√¨ l·∫•y t·ª´ token
        const name = userNameFromGoogle || userData?.sub || 'guest'; // 'guest' l√† gi√° tr·ªã m·∫∑c ƒë·ªãnh

        console.log("User data:", userData);
        console.log("Username:", name);

        document.querySelectorAll('.exam-card').forEach(card => {
            card.addEventListener('click', function() {
                const examId = this.getAttribute('data-id');
                if (examId) {
                    window.location.href = `/exam?id=${examId}&username=${encodeURIComponent(name)}`;
                }
            });
        });
        if (token) {
            document.getElementById('hint').style.display="none";
            const userData = parseJwt(token);
            if (userData?.sub) {
                authSection.innerHTML = `
                <div class="dropdown">
                    <img src="/images/user_image.jpg" alt="Avatar" class="avatar" id="avatarBtn">
                    <div class="dropdown-content" id="dropdownMenu">
                        <div class="notification-header">
                            <strong>Th√¥ng b√°o</strong>
                            <p style="margin: 0;">B·∫°n ch∆∞a c√≥ th√¥ng b√°o m·ªõi.</p>
                            <a href="/notifications">Xem t·∫•t c·∫£ >></a>
                        </div>
                        <hr>
                        <a href="#">L·ªãch h·ªçc c·ªßa t√¥i</a>
                        <a href="/user/profile">Trang c√° nh√¢n</a>
                        <a href="/user/logout" id="logoutBtn">ƒêƒÉng xu·∫•t</a>
                    </div>
                </div>
            `;

                setTimeout(() => {
                    const avatarBtn = document.getElementById("avatarBtn");
                    const dropdown = document.getElementById("dropdownMenu");
                    const logoutBtn = document.getElementById("logoutBtn");

                    avatarBtn.addEventListener("click", function () {
                        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    });

                    logoutBtn.addEventListener("click", function (e) {
                        e.preventDefault();
                        fetch('/user/logout', {
                            method: 'POST',
                            credentials: 'include'
                        }).then(res => {
                            if (res.ok) {
                                localStorage.removeItem("access_token")
                                Swal.fire({
                                    icon: 'success',
                                    title: 'ƒêƒÉng xu·∫•t th√†nh c√¥ng',
                                    showConfirmButton: false,
                                    timer: 1500
                                }).then(() => {
                                    window.location.href = '/login'; // Ho·∫∑c trang b·∫°n mu·ªën redirect
                                });
                            }
                        });

                    });

                    document.addEventListener("click", function (event) {
                        if (!event.target.closest('.dropdown')) {
                            dropdown.style.display = "none";
                        }
                    });
                }, 0);
            }
        }else{
            document.getElementById('hint').style.display="block";
        }

    });
</script>
